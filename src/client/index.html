<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" 
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <style>
      .jumbotron {
        background-color: #e6ffe6;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div id="elm-app-is-loaded-here"></div>
    
    <script src="elm.js"></script>
    <script>
      class CustomFile extends HTMLElement {
        constructor() {
          super();
          this.processFile = this.processFile.bind(this);
        }

        processFile(evt) {
          const file = evt.target.files[0];
          const filename = file.name;
          const reader = new FileReader();

          reader.onload = (e) => {
            const data = e.target.result;
            const iv = crypto.getRandomValues(new Uint8Array(16));

            crypto.subtle.generateKey({ 'name': 'AES-CBC', 'length': 256 }, false, ['encrypt', 'decrypt'])
              .then(key => crypto.subtle.encrypt({ 'name': 'AES-CBC', iv }, key, data) )
              .then(encrypted => {
                const evt = new CustomEvent("file-selected", {
                  detail: new File([encrypted.buffer], filename)
                }) ;
                this.dispatchEvent(evt);
              })
              .catch(console.error);
          }

          reader.readAsArrayBuffer(file);
        }

        connectedCallback() {
          const input = document.createElement('input');
          input.type = "file";
          input.addEventListener('change', this.processFile)
          input.innerHtml = "Open file";
          this.appendChild(input);
        }
      }
      customElements.define('custom-file', CustomFile);
      Elm.HomePage.init({
        node: document.getElementById("elm-app-is-loaded-here")
      });
    </script>
  </body>
</html>
